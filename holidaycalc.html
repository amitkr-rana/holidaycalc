!DOCTYPE html
html lang=en

head
    meta charset=UTF-8
    meta name=viewport content=width=device-width, initial-scale=1.0
    titleHoliday Chain Calculatortitle
    style
        root {
            --bg-color #fff;
            --text-color #333;
            --text-light-color #888;
            --border-color #ddd;
            --header-bg rgba(255, 255, 255, 0.9);
            --header-border rgba(221, 221, 221, 0.7);
            --blue #3182ce;
            --green #28a745;
        }

        body.dark-mode {
            --bg-color #1a202c;
            --text-color #e2e8f0;
            --text-light-color #a0aec0;
            --border-color #4a5568;
            --header-bg rgba(26, 32, 44, 0.9);
            --header-border rgba(74, 85, 104, 0.7);
        }

         {
            margin 0;
            padding 0;
            box-sizing border-box;
        }

        html {
            scroll-behavior smooth;
            scrollbar-width none;
        }

        body {
            font-family -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding 20px;
            background var(--bg-color);
            color var(--text-color);
            -ms-overflow-style none;
            transition background-color 0.3s, color 0.3s;
        }

        body-webkit-scrollbar {
            display none;
        }

        .container {
            max-width 1400px;
            margin 0 auto;
        }
        
        .header-sticky {
            position sticky;
            top 0;
            background var(--header-bg);
            backdrop-filter blur(5px);
            -webkit-backdrop-filter blur(5px);
            z-index 10;
            padding-top 20px;
            padding-bottom 20px;
            border-bottom 1px solid var(--header-border);
            transition background-color 0.3s, border-color 0.3s;
        }

        h1 {
            text-align center;
            margin-bottom 20px;
            font-weight 600;
        }

        .controls {
            display flex;
            gap 15px;
            justify-content center;
            align-items center;
            flex-wrap wrap;
        }

        .controls select,
        .controls button {
            padding 8px 16px;
            font-size 14px;
            border-radius 6px;
            border 1px solid var(--border-color);
            cursor pointer;
            background var(--bg-color);
            color var(--text-color);
            transition background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .controls button.clear {
            background var(--blue);
            color white;
            border-color var(--blue);
        }

        .theme-switch-wrapper {
            display flex;
            align-items center;
        }
        .theme-switch {
            position relative;
            display inline-block;
            width 50px;
            height 26px;
        }
        .theme-switch input {
            opacity 0;
            width 0;
            height 0;
        }
        .slider {
            position absolute;
            cursor pointer;
            top 0;
            left 0;
            right 0;
            bottom 0;
            background-color #ccc;
            transition .4s;
            border-radius 26px;
        }
        body.dark-mode .slider {
            background-color #4a5568;
        }
        .sliderbefore {
            position absolute;
            content ;
            height 18px;
            width 18px;
            left 4px;
            bottom 4px;
            background-color white;
            transition .4s;
            border-radius 50%;
        }
        inputchecked + .slider {
            background-color var(--blue);
        }
        inputchecked + .sliderbefore {
            transform translateX(24px);
        }

        .calendar-container {
            display grid;
            grid-template-columns repeat(auto-fit, minmax(300px, 1fr));
            gap 40px 20px;
            padding-top 20px;
        }

        .month-view {
            text-align center;
        }

        .month-title {
            font-weight 600;
            margin-bottom 15px;
        }

        .days-grid {
            display grid;
            grid-template-columns repeat(7, 1fr);
            row-gap 10px;
            font-size 14px;
        }

        .weekday-header {
            font-weight 500;
            color var(--text-light-color);
            padding-bottom 5px;
        }

        .day {
            display flex;
            justify-content center;
            align-items center;
            height 36px;
            position relative;
            cursor pointer;
        }

        .day.fade, .day.disabled {
            color #ccc;
            pointer-events none;
            cursor default;
        }
        body.dark-mode .day.fade, body.dark-mode .day.disabled {
            color #4a5568;
        }

        .day span {
            display flex;
            justify-content center;
            align-items center;
            width 32px;
            height 32px;
            border-radius 50%;
            transition background-color 0.2s;
        }

        .day.holiday span {
            font-weight bold;
            background-color var(--blue);
            color white;
        }
        
        .day.longest-chainnot(.holiday)not(.weekend) span,
        .day.shortest-chainnot(.holiday)not(.weekend) span {
            background-color var(--green);
            color white;
        }

        .day.longest-chain.weekendnot(.holiday) span,
        .day.shortest-chain.weekendnot(.holiday) span {
            border 2px dashed var(--green);
            background-color transparent;
            color var(--text-color);
        }

        .day.leave-dayafter {
            content '';
            position absolute;
            bottom 4px;
            left 50%;
            transform translateX(-50%);
            width 4px;
            height 4px;
            border-radius 50%;
            background var(--green);
        }
        
        .day.longest-chainnot(.weekend).leave-dayafter,
        .day.shortest-chainnot(.weekend).leave-dayafter,
        .day.holiday.leave-dayafter {
            background #fff;
        }
    style
head

body
    div class=container
        div class=header-sticky
            h1Holiday Chain Calculatorh1

            div class=controls
                label
                    Year
                    select id=yearSelectselect
                label
                button id=clearBtn class=clearClear Holidaysbutton
                div class=theme-switch-wrapper
                    label class=theme-switch for=theme-toggle
                        input type=checkbox id=theme-toggle 
                        span class=slider roundspan
                    label
                div
            div
        div

        div id=calendarContainer class=calendar-containerdiv

    div

    script
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const weekdayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        let currentYear = new Date().getFullYear();
        let holidays = new Set();
        
        const themeToggle = document.getElementById('theme-toggle');

        (function () {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }
        })();

        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        });

        function initYearSelector() {
            const select = document.getElementById('yearSelect');
            const currentYearVal = new Date().getFullYear();
            for (let year = currentYearVal - 5; year = currentYearVal + 10; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYearVal) option.selected = true;
                select.appendChild(option);
            }
            select.addEventListener('change', (e) = {
                currentYear = parseInt(e.target.value);
                clearHolidays(false);
                updateDisplay();
            });
        }

        function getDayOfWeek(date) {
            const day = date.getDay();
            return day === 0  6  day - 1;
        }

        function isWeekend(date) {
            const dow = getDayOfWeek(date);
            return dow === 5  dow === 6;
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0)  (year % 400 === 0);
        }

        function dateKey(date) {
            if (!date) return '';
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function keyToDate(key) {
            const [y, m, d] = key.split('-').map(Number);
            return new Date(y, m - 1, d);
        }
        
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            if (!container) return;
            container.innerHTML = '';

            const totalMonthsToRender = 14;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i  totalMonthsToRender; i++) {
                const displayYear = currentYear + Math.floor(i  12);
                const displayMonth = i % 12;

                const monthView = document.createElement('div');
                monthView.className = 'month-view';
                monthView.dataset.monthKey = `${displayYear}-${displayMonth}`;
                
                const title = document.createElement('h3');
                title.className = 'month-title';
                title.textContent = `${monthNames[displayMonth]} ${displayYear}`;
                monthView.appendChild(title);

                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';

                weekdayNames.forEach(name = {
                    const headerEl = document.createElement('div');
                    headerEl.className = 'weekday-header';
                    headerEl.textContent = name.charAt(0);
                    daysGrid.appendChild(headerEl);
                });

                const firstDayOfMonth = new Date(displayYear, displayMonth, 1);
                const daysInMonthValue = new Date(displayYear, displayMonth + 1, 0).getDate();
                let startDayOfWeek = getDayOfWeek(firstDayOfMonth);
                const prevMonthLastDay = new Date(displayYear, displayMonth, 0).getDate();

                for (let j = 0; j  startDayOfWeek; j++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day fade';
                    dayEl.innerHTML = `span${prevMonthLastDay - startDayOfWeek + j + 1}span`;
                    daysGrid.appendChild(dayEl);
                }

                for (let day = 1; day = daysInMonthValue; day++) {
                    const date = new Date(displayYear, displayMonth, day);
                    const key = dateKey(date);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day';
                    dayEl.innerHTML = `span${day}span`;
                    dayEl.dataset.date = key;
                    
                    if (date  today) {
                        dayEl.classList.add('disabled');
                    } else if (!isWeekend(date)) {
                         dayEl.addEventListener('click', () = toggleHoliday(key));
                    } else {
                         dayEl.style.cursor = 'default';
                         dayEl.classList.add('weekend');
                    }
                    
                    daysGrid.appendChild(dayEl);
                }

                const totalCells = daysGrid.children.length - 7;
                const totalRows = Math.ceil(totalCells  7);
                const cellsToFill = (totalRows  7) - totalCells;

                for (let j = 1; j = cellsToFill; j++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day fade';
                    dayEl.innerHTML = `span${j}span`;
                    daysGrid.appendChild(dayEl);
                }

                monthView.appendChild(daysGrid);
                container.appendChild(monthView);
            }
        }

        function updateDisplay() {
            renderCalendar();

            if (holidays.size === 0) {
                return; 
            }

            const firmHolidays = Array.from(holidays).map(keyToDate).sort((a, b) = a - b);
            
            const holidayGroups = groupHolidays(firmHolidays);
            const chains = [];
            let leavesUsedByMonth = {};

            for (const group of holidayGroups) {
                const chain = buildBestChain(group, leavesUsedByMonth);
                if (chain) {
                    chains.push(chain);
                    chain.leaveDays.forEach(leave = {
                        const monthKey = `${leave.getFullYear()}-${leave.getMonth()}`;
                        leavesUsedByMonth[monthKey] = (leavesUsedByMonth[monthKey]  0) + 1;
                    });
                }
            }

            if (chains.length === 0) {
                return;
            }

            chains.sort((a, b) = b.totalDays - a.totalDays);
            const longest = chains[0];
            const shortest = chains.length  1  chains[chains.length - 1]  longest;

            highlightChains(longest, shortest);
        }

        function toggleHoliday(key) {
            if (holidays.has(key)) {
                holidays.delete(key);
            } else {
                holidays.add(key);
            }
            updateDisplay();
        }

        function groupHolidays(firmHolidays) {
             if (!firmHolidays.length) return [];
            const groups = [];
            let currentGroup = [firmHolidays[0]];
            for (let i = 1; i  firmHolidays.length; i++) {
                let prev = firmHolidays[i-1];
                let current = firmHolidays[i];
                let diff = (current - prev)  (1000  60  60  24);
                
                let workingDaysBetween = 0;
                let tempDate = new Date(prev);
                for(let j=1; jdiff; j++) {
                    tempDate.setDate(tempDate.getDate() + 1);
                    if(!isWeekend(tempDate)) {
                        workingDaysBetween++;
                    }
                }

                if (workingDaysBetween = 2) {
                    currentGroup.push(current);
                } else {
                    groups.push(currentGroup);
                    currentGroup = [current];
                }
            }
            groups.push(currentGroup);
            return groups;
        }
        
         --- FINAL, ROBUST buildBestChain FUNCTION ---
        function buildBestChain(holidayGroup, leavesUsedByMonth) {
            const maxLeaves = 2;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const allOffDays = new Set();
            for (let y = currentYear; y = currentYear + 1; y++) {
                 for (let m = 0; m  12; m++) {
                    const daysInMonth = new Date(y, m + 1, 0).getDate();
                    for (let d = 1; d = daysInMonth; d++) {
                        const date = new Date(y,m,d);
                        if(isWeekend(date)  holidays.has(dateKey(date))) {
                            allOffDays.add(dateKey(date));
                        }
                    }
                 }
            }
            
            if (!holidayGroup  holidayGroup.length === 0) return null;

            const sortedGroup = [...holidayGroup].sort((a, b) = a - b);
            let internalLeaves = [];
            
            let firstDayInGroup = new Date(sortedGroup[0]);
            let lastDayInGroup = new Date(sortedGroup[sortedGroup.length - 1]);

            for(let d = new Date(firstDayInGroup); d = lastDayInGroup; d.setDate(d.getDate() + 1)) {
                if (d = today && !isWeekend(d) && !holidays.has(dateKey(d))) {
                    internalLeaves.push(new Date(d));
                }
            }

            if (internalLeaves.length  maxLeaves) return null;

            const remainingLeaves = maxLeaves - internalLeaves.length;

            const createOption = (leavesBefore, leavesAfter) = {
                let externalLeaves = [];
                let tempDate = new Date(firstDayInGroup);

                for(let i=0; i  leavesBefore; i++) {
                    tempDate.setDate(tempDate.getDate() - 1);
                    if (tempDate  today) break;
                    if (allOffDays.has(dateKey(tempDate))) { i--; continue; }
                    const monthKey = `${tempDate.getFullYear()}-${tempDate.getMonth()}`;
                    if ((leavesUsedByMonth[monthKey]  0) + internalLeaves.filter(l=l.getMonth() === tempDate.getMonth()).length + externalLeaves.filter(l = l.getMonth() === tempDate.getMonth()).length = maxLeaves) break;
                    externalLeaves.unshift(new Date(tempDate));
                }
                
                tempDate = new Date(lastDayInGroup);
                for(let i=0; i  leavesAfter; i++) {
                    tempDate.setDate(tempDate.getDate() + 1);
                    if (allOffDays.has(dateKey(tempDate))) { i--; continue; }
                    const monthKey = `${tempDate.getFullYear()}-${tempDate.getMonth()}`;
                    if ((leavesUsedByMonth[monthKey]  0) + internalLeaves.filter(l=l.getMonth() === tempDate.getMonth()).length + externalLeaves.filter(l = l.getMonth() === tempDate.getMonth()).length = maxLeaves) break;
                    externalLeaves.push(new Date(tempDate));
                }
                
                const allKeyPoints = [...sortedGroup, ...internalLeaves, ...externalLeaves].sort((a,b) = a-b);
                if (allKeyPoints.length === 0) return { dates [], leaveDays [], totalDays 0 };
                
                let firstDayOfChain = new Date(allKeyPoints[0]);
                let lastDayOfChain = new Date(allKeyPoints[allKeyPoints.length-1]);
                
                let tempStart = new Date(firstDayOfChain);
                while(true) {
                    tempStart.setDate(tempStart.getDate() - 1);
                    if(allOffDays.has(dateKey(tempStart))) {
                        firstDayOfChain.setDate(firstDayOfChain.getDate() - 1);
                    } else {
                        break;
                    }
                }
                
                let tempEnd = new Date(lastDayOfChain);
                 while(true) {
                    tempEnd.setDate(tempEnd.getDate() + 1);
                    if(allOffDays.has(dateKey(tempEnd))) {
                        lastDayOfChain.setDate(lastDayOfChain.getDate() + 1);
                    } else {
                        break;
                    }
                }

                let finalChain = [];
                for (let d = new Date(firstDayOfChain); d = lastDayOfChain; d.setDate(d.getDate() + 1)) {
                    finalChain.push(new Date(d));
                }

                const finalLeaves = finalChain.filter(d = !allOffDays.has(dateKey(d)));
                return { dates finalChain, leaveDays finalLeaves, totalDays finalChain.length };
            };

            const optionLeft = createOption(remainingLeaves, 0);
            const optionRight = createOption(0, remainingLeaves);
            const optionBookend = (remainingLeaves = 2)  createOption(1, 1)  {totalDays 0};
            
            let bestOption = optionLeft;
            if (optionRight.totalDays = bestOption.totalDays) bestOption = optionRight;
            if (optionBookend.totalDays  bestOption.totalDays) {
                 bestOption = optionBookend;
            } else if (optionBookend.totalDays === bestOption.totalDays && (bestOption === optionRight  bestOption === optionLeft)) {
                 bestOption = optionBookend;
            }
           
            if (!bestOption  !bestOption.dates  bestOption.dates.length === 0) return null;
            
            bestOption.start = bestOption.dates[0];
            bestOption.end = bestOption.dates[bestOption.dates.length - 1];
            return bestOption;
        }

        function highlightChains(longest, shortest) {
            holidays.forEach(hKey = {
                 const elem = document.querySelector(`[data-date=${hKey}]`);
                 if (elem) elem.classList.add('holiday');
            });

            if (longest && longest.dates && Array.isArray(longest.dates)) {
                longest.dates.forEach(date = {
                    const elem = document.querySelector(`[data-date=${dateKey(date)}]`);
                    if (elem) elem.classList.add('longest-chain');
                });
                longest.leaveDays.forEach(date = {
                    const elem = document.querySelector(`[data-date=${dateKey(date)}]`);
                    if (elem) elem.classList.add('leave-day');
                });
            }
            if (shortest && longest && shortest.start && longest.start && shortest.start.getTime() !== longest.start.getTime()) {
                if (shortest.dates && Array.isArray(shortest.dates)) {
                    shortest.dates.forEach(date = {
                        const elem = document.querySelector(`[data-date=${dateKey(date)}]`);
                        if (elem) elem.classList.add('shortest-chain');
                    });
                    shortest.leaveDays.forEach(date = {
                        const elem = document.querySelector(`[data-date=${dateKey(date)}]`);
                         if (elem && !elem.classList.contains('longest-chain')) elem.classList.add('leave-day');
                    });
                }
            }
        }

        function clearHolidays(shouldUpdate = true) {
            holidays.clear();
            if (shouldUpdate) {
                updateDisplay();
            }
        }

        document.getElementById('clearBtn').addEventListener('click', () = clearHolidays(true));
        
        initYearSelector();
        updateDisplay();
        
        setTimeout(() = {
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const currentMonthEl = document.querySelector(`[data-month-key=${currentMonthKey}]`);
            const headerEl = document.querySelector('.header-sticky');

            if (currentMonthEl && headerEl) {
                const headerHeight = headerEl.offsetHeight;
                const elementPosition = currentMonthEl.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
      
                window.scrollTo({
                     top offsetPosition,
                     behavior smooth
                });
            }
        }, 2000);
    script
body
html